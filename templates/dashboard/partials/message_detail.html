<!-- Message Detail Header -->
<div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
    <h2 class="text-xl font-bold text-gray-900">Message Details</h2>
    <button type="button" class="close-modal text-gray-400 hover:text-gray-500">
        <span class="sr-only">Close</span>
        <i class="fas fa-times"></i>
    </button>
</div>

<!-- Message Content -->
<div class="p-6">
    <!-- Message Header -->
    <div class="mb-6">
        <h3 class="text-lg font-bold text-gray-900 mb-2">{{ message.subject }}</h3>
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
            <!-- From/To -->
            <div>
                {% if message.message_type == 'system' %}
                <span class="font-medium">From:</span> System
                {% elif message.message_type == 'user_to_admin' %}
                <span class="font-medium">From:</span> {{ message.sender.get_full_name }} ({{ message.sender.email }})
                {% elif message.message_type == 'admin_to_user' %}
                <span class="font-medium">To:</span> {{ message.recipient.get_full_name }} ({{ message.recipient.email }})
                {% elif message.message_type == 'broadcast' %}
                <span class="font-medium">Broadcast to:</span> All Users
                {% endif %}
            </div>
            
            <!-- Date -->
            <div>
                <span class="font-medium">Date:</span> {{ message.created_at|date:"F j, Y, g:i a" }}
            </div>
            
            <!-- Message Type -->
            <div>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                    {% if message.message_type == 'system' %}bg-gray-100 text-gray-800
                    {% elif message.message_type == 'user_to_admin' %}bg-blue-100 text-blue-800
                    {% elif message.message_type == 'admin_to_user' %}bg-green-100 text-green-800
                    {% elif message.message_type == 'broadcast' %}bg-purple-100 text-purple-800
                    {% endif %}">
                    {% if message.message_type == 'system' %}
                    System
                    {% elif message.message_type == 'user_to_admin' %}
                    From Customer
                    {% elif message.message_type == 'admin_to_user' %}
                    To Customer
                    {% elif message.message_type == 'broadcast' %}
                    Broadcast
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Message Body -->
    <div class="prose max-w-none mb-6 p-4 bg-gray-50 rounded-lg">
        {{ message.content|safe }}
    </div>
    
    <!-- Attachments -->
    {% if message.attachments.exists %}
    <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Attachments</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for attachment in message.attachments.all %}
            <div class="border border-gray-200 rounded-lg p-3 flex items-center">
                <div class="flex-shrink-0 h-10 w-10 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                    {% if attachment.file_type == 'image' %}
                    <i class="fas fa-image text-blue-500"></i>
                    {% elif attachment.file_type == 'document' %}
                    <i class="fas fa-file-alt text-green-500"></i>
                    {% elif attachment.file_type == 'pdf' %}
                    <i class="fas fa-file-pdf text-red-500"></i>
                    {% else %}
                    <i class="fas fa-file text-gray-500"></i>
                    {% endif %}
                </div>
                <div class="min-w-0 flex-1">
                    <p class="text-sm font-medium text-gray-900 truncate">{{ attachment.filename }}</p>
                    <p class="text-xs text-gray-500">{{ attachment.file_size|filesizeformat }}</p>
                </div>
                <a href="{{ attachment.file.url }}" download class="ml-4 flex-shrink-0 text-blue-600 hover:text-blue-800">
                    <i class="fas fa-download"></i>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Related Messages (Thread) -->
    {% if message.parent or message.replies.exists %}
    <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Message Thread</h4>
        <div class="border border-gray-200 rounded-lg divide-y divide-gray-200">
            {% if message.parent %}
            <div class="p-4 bg-gray-50">
                <div class="flex items-start">
                    <div class="flex-shrink-0 mr-4">
                        {% if message.parent.sender.avatar %}
                        <img src="{{ message.parent.sender.avatar.url }}" alt="{{ message.parent.sender.get_full_name }}" class="h-8 w-8 rounded-full">
                        {% else %}
                        <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                            <span class="text-gray-500 text-xs">{{ message.parent.sender.first_name|first }}{{ message.parent.sender.last_name|first }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">
                            {{ message.parent.sender.get_full_name }} - {{ message.parent.created_at|date:"M d, H:i" }}
                        </p>
                        <p class="text-sm text-gray-700 mt-1">
                            {{ message.parent.content|striptags|truncatechars:100 }}
                        </p>
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800 mt-1 inline-block view-message" data-message-id="{{ message.parent.id }}">View message</a>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% for reply in message.replies.all %}
            <div class="p-4 {% if reply.message_type == 'admin_to_user' %}bg-blue-50{% endif %}">
                <div class="flex items-start">
                    <div class="flex-shrink-0 mr-4">
                        {% if reply.sender.avatar %}
                        <img src="{{ reply.sender.avatar.url }}" alt="{{ reply.sender.get_full_name }}" class="h-8 w-8 rounded-full">
                        {% else %}
                        <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                            <span class="text-gray-500 text-xs">{{ reply.sender.first_name|first }}{{ reply.sender.last_name|first }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">
                            {{ reply.sender.get_full_name }} - {{ reply.created_at|date:"M d, H:i" }}
                        </p>
                        <p class="text-sm text-gray-700 mt-1">
                            {{ reply.content|striptags|truncatechars:100 }}
                        </p>
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800 mt-1 inline-block view-message" data-message-id="{{ reply.id }}">View message</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3">
        {% if message.message_type == 'user_to_admin' %}
        <button type="button" class="reply-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center" data-message-id="{{ message.id }}">
            <i class="fas fa-reply mr-2"></i>
            Reply
        </button>
        {% endif %}
        
        {% if message.status != 'archived' %}
        <button type="button" class="archive-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium flex items-center" data-message-id="{{ message.id }}">
            <i class="fas fa-archive mr-2"></i>
            Archive
        </button>
        {% else %}
        <button type="button" class="unarchive-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium flex items-center" data-message-id="{{ message.id }}">
            <i class="fas fa-inbox mr-2"></i>
            Move to Inbox
        </button>
        {% endif %}
        
        {% if message.message_type == 'user_to_admin' or message.message_type == 'admin_to_user' %}
        <button type="button" class="forward-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium flex items-center" data-message-id="{{ message.id }}">
            <i class="fas fa-share mr-2"></i>
            Forward
        </button>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // View related message
        document.querySelectorAll('.view-message').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const messageId = this.getAttribute('data-message-id');
                openMessageDetail(messageId);
            });
        });
        
        // Reply to message
        const replyBtn = document.querySelector('.reply-btn');
        if (replyBtn) {
            replyBtn.addEventListener('click', function() {
                const messageId = this.getAttribute('data-message-id');
                openReplyForm(messageId);
            });
        }
        
        // Archive message
        const archiveBtn = document.querySelector('.archive-btn');
        if (archiveBtn) {
            archiveBtn.addEventListener('click', function() {
                const messageId = this.getAttribute('data-message-id');
                archiveMessage(messageId);
            });
        }
        
        // Unarchive message
        const unarchiveBtn = document.querySelector('.unarchive-btn');
        if (unarchiveBtn) {
            unarchiveBtn.addEventListener('click', function() {
                const messageId = this.getAttribute('data-message-id');
                unarchiveMessage(messageId);
            });
        }
        
        // Forward message
        const forwardBtn = document.querySelector('.forward-btn');
        if (forwardBtn) {
            forwardBtn.addEventListener('click', function() {
                const messageId = this.getAttribute('data-message-id');
                openForwardForm(messageId);
            });
        }
        
        // Function to open reply form
        function openReplyForm(messageId) {
            // Close current modal
            closeMessageDetail();
            
            // Open compose modal with reply form
            const composeMessageModal = document.getElementById('compose-message-modal');
            const composeMessageContent = document.getElementById('compose-message-content');
            
            // Show modal
            composeMessageModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load reply form via AJAX
            fetch(`/dashboard/messages/${messageId}/reply/`)
                .then(response => response.text())
                .then(html => {
                    composeMessageContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = composeMessageContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeComposeMessage);
                    }
                    
                    // Add event listener to form submit
                    const form = composeMessageContent.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitReplyForm(form, messageId);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading reply form:', error);
                    composeMessageContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading reply form. Please try again.</p></div>';
                });
        }
        
        // Function to archive message
        function archiveMessage(messageId) {
            fetch(`/dashboard/messages/${messageId}/archive/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    closeMessageDetail();
                    
                    // Reload messages list
                    location.reload();
                } else {
                    alert('Error archiving message. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error archiving message:', error);
                alert('Error archiving message. Please try again.');
            });
        }
        
        // Function to unarchive message
        function unarchiveMessage(messageId) {
            fetch(`/dashboard/messages/${messageId}/unarchive/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    closeMessageDetail();
                    
                    // Reload messages list
                    location.reload();
                } else {
                    alert('Error unarchiving message. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error unarchiving message:', error);
                alert('Error unarchiving message. Please try again.');
            });
        }
        
        // Function to open forward form
        function openForwardForm(messageId) {
            // Close current modal
            closeMessageDetail();
            
            // Open compose modal with forward form
            const composeMessageModal = document.getElementById('compose-message-modal');
            const composeMessageContent = document.getElementById('compose-message-content');
            
            // Show modal
            composeMessageModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load forward form via AJAX
            fetch(`/dashboard/messages/${messageId}/forward/`)
                .then(response => response.text())
                .then(html => {
                    composeMessageContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = composeMessageContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeComposeMessage);
                    }
                    
                    // Add event listener to form submit
                    const form = composeMessageContent.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitForwardForm(form, messageId);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading forward form:', error);
                    composeMessageContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading forward form. Please try again.</p></div>';
                });
        }
        
        // Helper functions
        function closeMessageDetail() {
            const messageDetailModal = document.getElementById('message-detail-modal');
            messageDetailModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        function closeComposeMessage() {
            const composeMessageModal = document.getElementById('compose-message-modal');
            composeMessageModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
