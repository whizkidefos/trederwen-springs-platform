{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}{{ site_settings.site_name }} - Products Management{% endblock %}

{% block breadcrumbs %}
<li>
    <div class="flex items-center">
        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <span class="ml-1 text-gray-700">Products</span>
    </div>
</li>
{% endblock %}

{% block page_title %}Products Management{% endblock %}
{% block page_subtitle %}Manage your product catalog{% endblock %}

{% block page_actions %}
<div class="flex space-x-3">
    <a href="#" id="add-product-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
        <i class="fas fa-plus mr-2"></i>
        Add Product
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Product Filters Component -->
{% include 'dashboard/components/product_filters.html' %}

<!-- Products List Component -->
<div id="products-list-container">
    {% include 'dashboard/components/products_list.html' %}
</div>

<!-- Product Detail Modal -->
<div id="product-detail-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div id="product-detail-content">
                <!-- Product detail content will be loaded here via AJAX -->
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div id="product-form-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="form-modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div id="product-form-content">
                <!-- Product form content will be loaded here via AJAX -->
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Product Detail Modal
        const productDetailModal = document.getElementById('product-detail-modal');
        const productDetailContent = document.getElementById('product-detail-content');
        const modalBackdrop = document.getElementById('modal-backdrop');
        
        // Add/Edit Product Modal
        const productFormModal = document.getElementById('product-form-modal');
        const productFormContent = document.getElementById('product-form-content');
        const formModalBackdrop = document.getElementById('form-modal-backdrop');
        const addProductBtn = document.getElementById('add-product-btn');
        
        // Open product detail modal when clicking on a product
        function setupProductItemListeners() {
            document.querySelectorAll('.product-item').forEach(item => {
                item.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    openProductDetail(productId);
                });
            });
            
            document.querySelectorAll('.edit-product-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent opening detail modal
                    const productId = this.getAttribute('data-product-id');
                    openProductForm(productId);
                });
            });
            
            document.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent opening detail modal
                    const productId = this.getAttribute('data-product-id');
                    if (confirm('Are you sure you want to delete this product?')) {
                        deleteProduct(productId);
                    }
                });
            });
        }
        
        // Setup initial listeners
        setupProductItemListeners();
        
        // Open add product modal when clicking on add button
        if (addProductBtn) {
            addProductBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openProductForm();
            });
        }
        
        // Close modals when clicking on backdrop
        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', function() {
                closeProductDetail();
            });
        }
        
        if (formModalBackdrop) {
            formModalBackdrop.addEventListener('click', function() {
                closeProductForm();
            });
        }
        
        // Filter form submission
        const filterForm = document.getElementById('product-filter-form');
        if (filterForm) {
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(filterForm);
                const params = new URLSearchParams();
                
                for (const [key, value] of formData.entries()) {
                    if (value) {
                        params.append(key, value);
                    }
                }
                
                // Load filtered products via AJAX
                fetch(`/dashboard/products/list/?${params.toString()}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('products-list-container').innerHTML = html;
                        setupProductItemListeners(); // Re-setup listeners for new content
                    })
                    .catch(error => {
                        console.error('Error loading filtered products:', error);
                    });
            });
        }
        
        // Function to open product detail modal
        function openProductDetail(productId) {
            // Show modal
            productDetailModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load product content via AJAX
            fetch(`/dashboard/products/${productId}/`)
                .then(response => response.text())
                .then(html => {
                    productDetailContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = productDetailContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeProductDetail);
                    }
                    
                    // Add event listener to edit button
                    const editBtn = productDetailContent.querySelector('.edit-product-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', function() {
                            closeProductDetail();
                            openProductForm(productId);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading product:', error);
                    productDetailContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading product. Please try again.</p></div>';
                });
        }
        
        // Function to close product detail modal
        function closeProductDetail() {
            productDetailModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Function to open product form modal
        function openProductForm(productId = null) {
            // Show modal
            productFormModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load form via AJAX
            const url = productId ? `/dashboard/products/${productId}/edit/` : '/dashboard/products/add/';
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    productFormContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = productFormContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeProductForm);
                    }
                    
                    // Add event listener to form submit
                    const form = productFormContent.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitProductForm(form, productId);
                        });
                    }
                    
                    // Initialize any form-specific JavaScript
                    initializeFormComponents();
                })
                .catch(error => {
                    console.error('Error loading form:', error);
                    productFormContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading form. Please try again.</p></div>';
                });
        }
        
        // Function to close product form modal
        function closeProductForm() {
            productFormModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Function to submit product form
        function submitProductForm(form, productId) {
            const formData = new FormData(form);
            const url = productId ? `/dashboard/products/${productId}/edit/` : '/dashboard/products/add/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    closeProductForm();
                    
                    // Reload products list
                    location.reload();
                } else {
                    // Show error message
                    const errorDiv = productFormContent.querySelector('.form-errors');
                    if (errorDiv) {
                        errorDiv.innerHTML = `<div class="p-4 mb-4 bg-red-100 text-red-700 rounded-lg">${data.error}</div>`;
                    }
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                const errorDiv = productFormContent.querySelector('.form-errors');
                if (errorDiv) {
                    errorDiv.innerHTML = '<div class="p-4 mb-4 bg-red-100 text-red-700 rounded-lg">An error occurred. Please try again.</div>';
                }
            });
        }
        
        // Function to delete product
        function deleteProduct(productId) {
            fetch(`/dashboard/products/${productId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload products list
                    location.reload();
                } else {
                    alert('Error deleting product. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                alert('Error deleting product. Please try again.');
            });
        }
        
        // Function to initialize form-specific components
        function initializeFormComponents() {
            // Image preview
            const imageInput = document.getElementById('id_image');
            const imagePreview = document.getElementById('image-preview');
            
            if (imageInput && imagePreview) {
                imageInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            imagePreview.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                        };
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
            
            // Rich text editor initialization
            if (typeof ClassicEditor !== 'undefined') {
                const descriptionField = document.getElementById('id_description');
                if (descriptionField) {
                    ClassicEditor
                        .create(descriptionField)
                        .catch(error => {
                            console.error(error);
                        });
                }
            }
        }
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
