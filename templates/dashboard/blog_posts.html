{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}{{ site_settings.site_name }} - Blog Posts Management{% endblock %}

{% block breadcrumbs %}
<li>
    <div class="flex items-center">
        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <span class="ml-1 text-gray-700">Blog Posts</span>
    </div>
</li>
{% endblock %}

{% block page_title %}Blog Posts Management{% endblock %}
{% block page_subtitle %}Manage your blog content{% endblock %}

{% block page_actions %}
<div class="flex space-x-3">
    <a href="#" id="add-post-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
        <i class="fas fa-plus mr-2"></i>
        Add Post
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Blog Post Filters Component -->
{% include 'dashboard/components/blog_post_filters.html' %}

<!-- Blog Posts List Component -->
<div id="blog-posts-list-container">
    {% include 'dashboard/components/blog_posts_list.html' %}
</div>

<!-- Blog Post Detail Modal -->
<div id="blog-post-detail-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div id="blog-post-detail-content">
                <!-- Blog post detail content will be loaded here via AJAX -->
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Blog Post Modal -->
<div id="blog-post-form-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="form-modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div id="blog-post-form-content">
                <!-- Blog post form content will be loaded here via AJAX -->
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Blog Post Detail Modal
        const blogPostDetailModal = document.getElementById('blog-post-detail-modal');
        const blogPostDetailContent = document.getElementById('blog-post-detail-content');
        const modalBackdrop = document.getElementById('modal-backdrop');
        
        // Add/Edit Blog Post Modal
        const blogPostFormModal = document.getElementById('blog-post-form-modal');
        const blogPostFormContent = document.getElementById('blog-post-form-content');
        const formModalBackdrop = document.getElementById('form-modal-backdrop');
        const addPostBtn = document.getElementById('add-post-btn');
        
        // Open blog post detail modal when clicking on a post
        function setupBlogPostItemListeners() {
            document.querySelectorAll('.blog-post-item').forEach(item => {
                item.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    openBlogPostDetail(postId);
                });
            });
            
            document.querySelectorAll('.edit-post-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent opening detail modal
                    const postId = this.getAttribute('data-post-id');
                    openBlogPostForm(postId);
                });
            });
            
            document.querySelectorAll('.delete-post-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent opening detail modal
                    const postId = this.getAttribute('data-post-id');
                    if (confirm('Are you sure you want to delete this blog post?')) {
                        deleteBlogPost(postId);
                    }
                });
            });
        }
        
        // Setup initial listeners
        setupBlogPostItemListeners();
        
        // Open add blog post modal when clicking on add button
        if (addPostBtn) {
            addPostBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openBlogPostForm();
            });
        }
        
        // Close modals when clicking on backdrop
        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', function() {
                closeBlogPostDetail();
            });
        }
        
        if (formModalBackdrop) {
            formModalBackdrop.addEventListener('click', function() {
                closeBlogPostForm();
            });
        }
        
        // Filter form submission
        const filterForm = document.getElementById('blog-post-filter-form');
        if (filterForm) {
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(filterForm);
                const params = new URLSearchParams();
                
                for (const [key, value] of formData.entries()) {
                    if (value) {
                        params.append(key, value);
                    }
                }
                
                // Load filtered blog posts via AJAX
                fetch(`/dashboard/blog-posts/list/?${params.toString()}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('blog-posts-list-container').innerHTML = html;
                        setupBlogPostItemListeners(); // Re-setup listeners for new content
                    })
                    .catch(error => {
                        console.error('Error loading filtered blog posts:', error);
                    });
            });
        }
        
        // Function to open blog post detail modal
        function openBlogPostDetail(postId) {
            // Show modal
            blogPostDetailModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load blog post content via AJAX
            fetch(`/dashboard/blog-posts/${postId}/`)
                .then(response => response.text())
                .then(html => {
                    blogPostDetailContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = blogPostDetailContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeBlogPostDetail);
                    }
                    
                    // Add event listener to edit button
                    const editBtn = blogPostDetailContent.querySelector('.edit-post-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', function() {
                            closeBlogPostDetail();
                            openBlogPostForm(postId);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading blog post:', error);
                    blogPostDetailContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading blog post. Please try again.</p></div>';
                });
        }
        
        // Function to close blog post detail modal
        function closeBlogPostDetail() {
            blogPostDetailModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Function to open blog post form modal
        function openBlogPostForm(postId = null) {
            // Show modal
            blogPostFormModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load form via AJAX
            const url = postId ? `/dashboard/blog-posts/${postId}/edit/` : '/dashboard/blog-posts/add/';
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    blogPostFormContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = blogPostFormContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeBlogPostForm);
                    }
                    
                    // Add event listener to form submit
                    const form = blogPostFormContent.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitBlogPostForm(form, postId);
                        });
                    }
                    
                    // Initialize any form-specific JavaScript
                    initializeFormComponents();
                })
                .catch(error => {
                    console.error('Error loading form:', error);
                    blogPostFormContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading form. Please try again.</p></div>';
                });
        }
        
        // Function to close blog post form modal
        function closeBlogPostForm() {
            blogPostFormModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Function to submit blog post form
        function submitBlogPostForm(form, postId) {
            const formData = new FormData(form);
            const url = postId ? `/dashboard/blog-posts/${postId}/edit/` : '/dashboard/blog-posts/add/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    closeBlogPostForm();
                    
                    // Reload blog posts list
                    location.reload();
                } else {
                    // Show error message
                    const errorDiv = blogPostFormContent.querySelector('.form-errors');
                    if (errorDiv) {
                        errorDiv.innerHTML = `<div class="p-4 mb-4 bg-red-100 text-red-700 rounded-lg">${data.error}</div>`;
                    }
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                const errorDiv = blogPostFormContent.querySelector('.form-errors');
                if (errorDiv) {
                    errorDiv.innerHTML = '<div class="p-4 mb-4 bg-red-100 text-red-700 rounded-lg">An error occurred. Please try again.</div>';
                }
            });
        }
        
        // Function to delete blog post
        function deleteBlogPost(postId) {
            fetch(`/dashboard/blog-posts/${postId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload blog posts list
                    location.reload();
                } else {
                    alert('Error deleting blog post. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error deleting blog post:', error);
                alert('Error deleting blog post. Please try again.');
            });
        }
        
        // Function to initialize form-specific components
        function initializeFormComponents() {
            // Featured image preview
            const imageInput = document.getElementById('id_featured_image');
            const imagePreview = document.getElementById('image-preview');
            
            if (imageInput && imagePreview) {
                imageInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            imagePreview.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                        };
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
            
            // Rich text editor initialization for content
            if (typeof ClassicEditor !== 'undefined') {
                const contentField = document.getElementById('id_content');
                if (contentField) {
                    ClassicEditor
                        .create(contentField)
                        .catch(error => {
                            console.error(error);
                        });
                }
            }
        }
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
