{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}{{ site_settings.site_name }} - Page Management{% endblock %}

{% block breadcrumbs %}
<li>
    <div class="flex items-center">
        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <span class="ml-1 text-gray-700">Pages</span>
    </div>
</li>
{% endblock %}

{% block page_title %}Page Management{% endblock %}
{% block page_subtitle %}Manage your website's static pages{% endblock %}

{% block page_actions %}
<div class="flex space-x-3">
    <a href="#" id="add-page-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
        <i class="fas fa-plus mr-2"></i>
        Add Page
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Page Filters Component -->
{% include 'dashboard/components/page_filters.html' %}

<!-- Pages List Component -->
<div id="pages-list-container">
    {% include 'dashboard/components/pages_list.html' %}
</div>

<!-- Page Detail Modal -->
<div id="page-detail-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div id="page-detail-content">
                <!-- Page detail content will be loaded here via AJAX -->
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Page Modal -->
<div id="page-form-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div id="form-modal-backdrop" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div id="page-form-content">
                <!-- Page form content will be loaded here via AJAX -->
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Page Detail Modal
        const pageDetailModal = document.getElementById('page-detail-modal');
        const pageDetailContent = document.getElementById('page-detail-content');
        const modalBackdrop = document.getElementById('modal-backdrop');
        
        // Add/Edit Page Modal
        const pageFormModal = document.getElementById('page-form-modal');
        const pageFormContent = document.getElementById('page-form-content');
        const formModalBackdrop = document.getElementById('form-modal-backdrop');
        const addPageBtn = document.getElementById('add-page-btn');
        
        // Open page detail modal when clicking on a page
        function setupPageItemListeners() {
            document.querySelectorAll('.page-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page-id');
                    openPageDetail(pageId);
                });
            });
            
            document.querySelectorAll('.edit-page-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent opening detail modal
                    const pageId = this.getAttribute('data-page-id');
                    openPageForm(pageId);
                });
            });
            
            document.querySelectorAll('.delete-page-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent opening detail modal
                    const pageId = this.getAttribute('data-page-id');
                    if (confirm('Are you sure you want to delete this page?')) {
                        deletePage(pageId);
                    }
                });
            });
        }
        
        // Setup initial listeners
        setupPageItemListeners();
        
        // Open add page modal when clicking on add button
        if (addPageBtn) {
            addPageBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openPageForm();
            });
        }
        
        // Close modals when clicking on backdrop
        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', function() {
                closePageDetail();
            });
        }
        
        if (formModalBackdrop) {
            formModalBackdrop.addEventListener('click', function() {
                closePageForm();
            });
        }
        
        // Filter form submission
        const filterForm = document.getElementById('page-filter-form');
        if (filterForm) {
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(filterForm);
                const params = new URLSearchParams();
                
                for (const [key, value] of formData.entries()) {
                    if (value) {
                        params.append(key, value);
                    }
                }
                
                // Load filtered pages via AJAX
                fetch(`/dashboard/pages/list/?${params.toString()}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('pages-list-container').innerHTML = html;
                        setupPageItemListeners(); // Re-setup listeners for new content
                    })
                    .catch(error => {
                        console.error('Error loading filtered pages:', error);
                    });
            });
        }
        
        // Function to open page detail modal
        function openPageDetail(pageId) {
            // Show modal
            pageDetailModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load page content via AJAX
            fetch(`/dashboard/pages/${pageId}/`)
                .then(response => response.text())
                .then(html => {
                    pageDetailContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = pageDetailContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closePageDetail);
                    }
                    
                    // Add event listener to edit button
                    const editBtn = pageDetailContent.querySelector('.edit-page-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', function() {
                            closePageDetail();
                            openPageForm(pageId);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    pageDetailContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading page. Please try again.</p></div>';
                });
        }
        
        // Function to close page detail modal
        function closePageDetail() {
            pageDetailModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Function to open page form modal
        function openPageForm(pageId = null) {
            // Show modal
            pageFormModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Load form via AJAX
            const url = pageId ? `/dashboard/pages/${pageId}/edit/` : '/dashboard/pages/add/';
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    pageFormContent.innerHTML = html;
                    
                    // Add event listeners to close button
                    const closeBtn = pageFormContent.querySelector('.close-modal');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closePageForm);
                    }
                    
                    // Add event listener to form submit
                    const form = pageFormContent.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitPageForm(form, pageId);
                        });
                    }
                    
                    // Initialize any form-specific JavaScript
                    initializeFormComponents();
                })
                .catch(error => {
                    console.error('Error loading form:', error);
                    pageFormContent.innerHTML = '<div class="p-6"><p class="text-red-600">Error loading form. Please try again.</p></div>';
                });
        }
        
        // Function to close page form modal
        function closePageForm() {
            pageFormModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Function to submit page form
        function submitPageForm(form, pageId) {
            const formData = new FormData(form);
            const url = pageId ? `/dashboard/pages/${pageId}/edit/` : '/dashboard/pages/add/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    closePageForm();
                    
                    // Reload pages list
                    location.reload();
                } else {
                    // Show error message
                    const errorDiv = pageFormContent.querySelector('.form-errors');
                    if (errorDiv) {
                        errorDiv.innerHTML = `<div class="p-4 mb-4 bg-red-100 text-red-700 rounded-lg">${data.error}</div>`;
                    }
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                const errorDiv = pageFormContent.querySelector('.form-errors');
                if (errorDiv) {
                    errorDiv.innerHTML = '<div class="p-4 mb-4 bg-red-100 text-red-700 rounded-lg">An error occurred. Please try again.</div>';
                }
            });
        }
        
        // Function to delete page
        function deletePage(pageId) {
            fetch(`/dashboard/pages/${pageId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload pages list
                    location.reload();
                } else {
                    alert('Error deleting page. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error deleting page:', error);
                alert('Error deleting page. Please try again.');
            });
        }
        
        // Function to initialize form-specific components
        function initializeFormComponents() {
            // Featured image preview
            const imageInput = document.getElementById('id_featured_image');
            const imagePreview = document.getElementById('image-preview');
            
            if (imageInput && imagePreview) {
                imageInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            imagePreview.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                        };
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
            
            // Rich text editor initialization for content
            if (typeof ClassicEditor !== 'undefined') {
                const contentField = document.getElementById('id_content');
                if (contentField) {
                    ClassicEditor
                        .create(contentField, {
                            toolbar: [
                                'heading',
                                '|',
                                'bold',
                                'italic',
                                'link',
                                'bulletedList',
                                'numberedList',
                                '|',
                                'outdent',
                                'indent',
                                '|',
                                'imageUpload',
                                'blockQuote',
                                'insertTable',
                                'mediaEmbed',
                                'undo',
                                'redo'
                            ]
                        })
                        .catch(error => {
                            console.error(error);
                        });
                }
            }
        }
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
